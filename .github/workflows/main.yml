# 每日上午11点微信定时推送工作流
# 文件名：.github/workflows/daily-wechat-push.yml（需放在仓库对应路径下）
name: 每日11点微信自动推送

# 工作流触发规则
on:
  # 1. 定时触发：GitHub默认UTC时区，北京时间=UTC+8，故北京时间11点对应UTC 3点
  # cron格式：分 时 日 月 周 → 0 3 * * * 表示每天UTC 3点（即北京时间11点）执行
  schedule:
    - cron: '0 16 * * *'
  # 2. 手动触发：在GitHub仓库「Actions」页面可手动点击运行，用于测试程序是否正常
  workflow_dispatch:

# 定义核心任务（仅1个任务：执行推送程序）
jobs:
  execute-push:
    # 任务运行环境：选择最新版Ubuntu系统（稳定、兼容性强，适配Python程序）
    runs-on: ubuntu-latest

    # 任务执行步骤（按顺序执行，无多余步骤）
    steps:
      ###########################################################################
      # 步骤1：检出GitHub仓库代码
      # 作用：将仓库中已有的文件（main.py、config.txt、requirements.txt等）下载到运行环境
      ###########################################################################
      - name: 检出仓库代码
        uses: actions/checkout@v4  # 官方代码检出工具，v4为最新稳定版本
        with:
          fetch-depth: 1  # 仅拉取最新一次提交记录，减少下载耗时

      ###########################################################################
      # 步骤2：配置Python运行环境
      # 作用：搭建与本地一致的Python环境，确保依赖包能正常安装和运行
      ###########################################################################
      - name: 设置Python环境
        uses: actions/setup-python@v5  # 官方Python环境配置工具
        with:
          python-version: '3.9'  # 推荐版本（兼容requirements.txt中的requests和zhdate，3.8+均可）
          cache: 'pip'  # 缓存pip依赖包，下次运行时无需重新下载，提升速度

      ###########################################################################
      # 步骤3：安装Python依赖包
      # 作用：根据requirements.txt安装程序所需的第三方库（requests、zhdate）
      ###########################################################################
      - name: 安装程序依赖
        run: |
          # 升级pip工具到最新版，避免因旧版pip导致依赖安装失败
          python -m pip install --upgrade pip
          # 读取requirements.txt并安装所有依赖
          pip install -r requirements.txt

      ###########################################################################
      # 步骤4：执行推送主程序
      # 作用：运行main.py，触发微信推送逻辑（使用仓库中已有的config.txt配置，不额外生成）
      ###########################################################################
      - name: 运行微信推送脚本
        run: python main.py  # 直接执行主程序
        env:
          # 设置运行环境时区为北京时间（避免程序中日期/时间计算出现偏差，如生日、恋爱天数）
          TZ: Asia/Shanghai

# 关键操作提示（用户必看）
# 1. 文件确认：确保仓库中已上传以下文件，且路径正确（根目录即可）：
#    - main.py（推送核心代码）
#    - config.txt（已包含app_id、API密钥等配置，无需修改）
#    - requirements.txt（已包含requests和zhdate依赖）
# 2. 敏感信息可选优化（非必需）：
#    若担心config.txt中的app_secret、API密钥等信息泄露，可将这些敏感值迁移到GitHub Secrets（仓库→Settings→Secrets and variables→Actions），
#    并修改main.py中读取配置的逻辑（从环境变量读取Secrets），但按您要求“不生成配置文件”，当前方案无需改动。
# 3. 测试方法：
#    配置完成后，进入GitHub仓库「Actions」页面，找到本工作流（名称：每日11点微信自动推送），
#    点击右侧「Run workflow」手动触发一次运行，查看日志（绿色对勾表示成功，红色叉号表示失败）。
# 4. 时区说明：
#    若需调整推送时间，只需修改cron表达式（如北京时间9点对应UTC 1点，cron改为'0 1 * * *'），格式严格遵循“分 时 日 月 周”。
